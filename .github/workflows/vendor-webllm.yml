name: Vendor WebLLM dist (dual path, robust)

on:
  workflow_dispatch:
  push:
    paths:
      - '**.html'
      - '**.js'
      - '**.css'
      - '.github/workflows/vendor-webllm.yml'

permissions:
  contents: write

jobs:
  vendor:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Fetch @mlc-ai/web-llm and copy to vendor paths
        shell: bash
        run: |
          set -euxo pipefail
          npm config set fund false
          npm config set audit false
          npm config set registry https://registry.npmjs.org/
          npm pack @mlc-ai/web-llm@latest
          TARBALL=$(ls @mlc-ai-web-llm-*.tgz | head -n 1)
          tar -xzf "$TARBALL"
          mkdir -p vendor/web-llm/dist docs/vendor/web-llm/dist
          rsync -a package/dist/ vendor/web-llm/dist/ --delete
          rsync -a package/dist/ docs/vendor/web-llm/dist/ --delete || true
          rm -rf package "$TARBALL"

      - name: Commit vendored files
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add -A
          git commit -m "Vendor web-llm dist (robust dual path)" || echo "No changes"
          git push
